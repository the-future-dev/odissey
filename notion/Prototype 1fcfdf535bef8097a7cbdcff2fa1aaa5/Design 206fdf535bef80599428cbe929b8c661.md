# Design

# Design

# High-Level Overview

## Software Architecture (Enhanced)

We adopt a **system prompt-driven, modular architecture** with clear boundaries and AI coherence management:

- **Presentation Layer**: Mobile/Web clients (React Native) with instant gratification and demo mode support
- **Application Layer**: Orchestrates user flows, session management, system prompt selection, and personality integration
- **AI Coherence Layer**: System prompt management, world artifact integration, rolling personality assessment
- **Domain Services**: AuthService, ProfileService, WorldService, InteractionService, DiscoveryService, CoherenceService
- **Abstraction Layer**: AIModelAdapter, SystemPromptManager, PersonalityAnalyzer, StorageAdapter, ConsentManager
- **Infrastructure Layer**: API Gateway, Datastores, Third-Party Integrations (Google OAuth, AI providers)

## Detailed Software Functionality Definition

### **Core System Prompt Framework**

- **SystemPromptManager**: Centralized prompt template management with personalization variables
- **CoherenceEngine**: Maintains story consistency through world artifacts and character memory
- **PersonalityIntegrator**: Applies rolling personality assessment to system prompt configuration
- **EngagementOptimizer**: Embeds instant gratification elements through strategic prompt placement

### **Enhanced Domain Services**

- **AuthService**: Intelligent routing (demo mode vs preference discovery), guest session management, Google SSO
- **ProfileService**: CRUD on user profile, rolling personality updates via LLM analysis, preference discovery management
- **WorldService**:
    - `generateNewWorldWithCoCreation(initialPrompt, userPersonality)` - GenAI-guided collaborative creation
    - `processStoryTemplate(userResponses)` - Template-based world validation
    - `uploadWorldSource(text, extractionPrompts)` - Content ingestion with system prompt guidance
    - `refineWorld(worldId, refinementPrompts, consistency)` - Coherence-aware world improvement
- **InteractionService**:
    - `startPersonalizedSession(worldId, userPersonality)` - Personality-aware world initialization
    - `interact(sessionId, userUtterance, worldArtifacts)` - Coherence-constrained story progression with streaming
    - `embedInstantGratification(sessionState, engagementLevel)` - Real-time reward integration
- **DiscoveryService**:
    - `servePreferenceDiscovery()` - Visual card-based quiz (3-5 questions)
    - `generateWorldPreviews(worlds, userPreferences)` - 30-second teasers with personalization
    - `enableQuickPlay(worldId, userPersonality)` - <10 second world access
- **AnalyticsService**:
    - `performRollingPersonalityAssessment(interactionLogs)` - LLM-powered personality updates
    - `trackSystemPromptEffectiveness(promptId, userEngagement)` - Prompt optimization metrics
    - `measureInstantGratification(sessionId, rewardEvents)` - Engagement optimization analytics

### **AI Integration Services**

- **GenAI Co-Creator**: System prompt-guided collaborative world building that stimulates creativity
- **Coherence Validator**: Real-time consistency checking against world artifacts and character memory
- **PersonalityAnalyzer**: Rolling assessment through interaction pattern analysis
- **ContentSafetyFilter**: Age-appropriate content validation through specialized system prompts

## Interfaces

### **Enhanced API Endpoints**

### **Authentication & Onboarding**

- POST `/auth/guest` → { sessionToken, routeToDemo: boolean }
- POST `/auth/google` → { sessionToken, routeToDemo: boolean }
- GET `/demo/worlds` → [demoWorldSummaries] (instant access)
- POST `/onboarding/preference-discovery` → { preferenceProfile, personalizedPrompts }

### **World Management with System Prompts**

- GET `/worlds?public=true&page={}&personality={}` → [personalizedWorldSummaries with previews]
- POST `/worlds/co-create` → streamed GenAI co-creation conversation
- POST `/worlds/template-validate` → { worldArtifacts, templateCompliance }
- POST `/worlds/upload` → { worldId, extractedArtifacts }
- PATCH `/worlds/{id}/refine` → { updatedWorldArtifacts, coherenceValidation }
- GET `/worlds/{id}/preview` → { 30secPreview, quickPlayReady }

### **Story Interaction & Coherence**

- POST `/sessions/personalized` → { sessionId, personalitySnapshot, worldState }
- POST `/sessions/{id}/interact` → streamed coherent narrator response with embedded rewards
- GET `/sessions/{id}/coherence-state` → { worldArtifacts, characterMemory, consistencyScore }

### **Personality & Analytics**

- POST `/personality/rolling-update` → { updatedTraits, confidenceLevel }
- GET `/analytics/engagement/{sessionId}` → { gratificationMetrics, promptEffectiveness }
- POST `/analytics/prompt-optimization` → { promptRecommendations, effectivenessScores }

### **Internal Interfaces (Enhanced)**

### **System Prompt Management**

- **ISystemPromptManager**
    - `getPersonalizedPrompt(type, userPersonality, worldContext): SystemPrompt`
    - `evaluatePromptEffectiveness(promptId, userResponse, engagement): EffectivenessScore`
    - `optimizePromptStrategy(analyticsData): OptimizedPrompts`

### **AI Model Integration**

- **IAiModel** (Enhanced)
    - `generateWorldWithCoCreation(initialPrompt, systemPrompts, userPersonality): StreamedArtifacts`
    - `maintainStoryCoherence(worldArtifacts, userAction, systemPrompts): CoherentResponse`
    - `analyzePersonalityFromInteraction(chatLogs, systemPrompts): PersonalityUpdate`
    - `embedInstantGratification(storyState, engagementPrompts): RewardIntegratedResponse`

### **Coherence & Consistency**

- **ICoherenceEngine**
    - `validateWorldConsistency(artifacts, newContent): ConsistencyReport`
    - `maintainCharacterMemory(characterId, interactions): UpdatedCharacter`
    - `enforceWorldRules(worldRules, proposedAction): RuleCompliantAction`

### **Persistence (Database / Logs) Enhanced**

### **Enhanced Schema Design**

- **Datastore Choice**: PostgreSQL with MongoDB for flexible artifact storage
- **Core Collections/Tables**:
    - `users`, `personality_assessments`, `preference_discoveries`, `system_prompts`
    - `worlds`, `world_artifacts`, `story_templates`, `demo_worlds`
    - `sessions`, `chat_logs`, `coherence_logs`, `engagement_events`
    - `prompt_effectiveness`, `personality_evolution`, `instant_gratification_metrics`

### **Advanced Logging Strategy**

- **System Prompt Logs**: Track prompt selection, personalization, and effectiveness
- **Coherence Logs**: Monitor story consistency and world rule adherence
- **Personality Evolution Logs**: Rolling assessment updates and confidence tracking
- **Engagement Logs**: Instant gratification events and user satisfaction metrics

## Decomposition

### Frontend (Enhanced)

### **Tech Stack with Instant Gratification**

- React Native (iOS/Android) with optimized performance for <10s world loading
- State Management: Redux with real-time personality integration
- Styling: Tailwind with kid-friendly visual card components
- Audio Integration: React Native Sound for voice narration support

### **Core Components (Enhanced)**

### **Instant Access & Discovery**

- **DemoModeLauncher**: One-click magical world access with pre-configured system prompts
- **PreferenceDiscoveryCards**: Visual, gamified 3-5 question interface
- **WorldPreviewPlayer**: 30-second teasers with thumbnail and quick-play integration
- **QuickPlayButton**: <10 second world initialization with personality awareness

### **World Building & Creation**

- **GenAI CoCreationChat**: Conversational interface with system prompt-guided creativity stimulation
- **StoryTemplateValidator**: Real-time template compliance checking during creation
- **WorldArtifactManager**: Visual representation of characters, settings, rules with consistency validation
- **CoherenceIndicator**: Real-time feedback on story consistency and world rule adherence

### **Story Experience**

- **PersonalityAwareNarrator**: Chat UI with rolling personality integration
- **InstantGratificationOverlay**: Embedded rewards, achievements, and surprise moments
- **CoherenceTracker**: Visual consistency indicators and character memory display
- **ProgressiveRevealManager**: Unlock system for story elements and features

### **Enhanced User Management**

- **RollingPersonalityDashboard**: Visual trait evolution and confidence indicators
- **PreferenceRecalibration**: Easy personality quiz retake with visual feedback
- **EngagementAnalytics**: Personal story engagement and preference insights

### **Frontend Services & Utilities (Enhanced)**

- **SystemPromptClient**: Handles personalized prompt configuration and caching
- **CoherenceValidator**: Real-time story consistency validation
- **PersonalityIntegrator**: Applies rolling assessment to UI personalization
- **InstantGratificationEngine**: Manages reward timing and progressive reveals
- **QuickPlayOptimizer**: Handles rapid world initialization and caching

## Backend (Enhanced)

### **Tech Stack with AI Coherence**

- Python with FastAPI and async support for real-time system prompt processing
- Celery for background personality analysis and prompt optimization
- Redis for system prompt caching and session state management
- Containerized via Docker with Kubernetes orchestration for AI service scaling

### **Enhanced Modules & Services**

### **AI Integration Layer**

- **SystemPromptOrchestrator**: Central prompt management with personalization engine
- **CoherenceManager**: World consistency enforcement and artifact integration
- **PersonalityAnalysisEngine**: Rolling LLM-powered personality assessment
- **EngagementOptimizer**: Real-time instant gratification integration

### **Enhanced Domain Modules**

- **AuthModule**: Intelligent demo/discovery routing with personality-aware content
- **ProfileModule**: Rolling personality updates with confidence tracking
- **WorldModule**: GenAI co-creation with template validation and coherence management
- **InteractionModule**: Personality-integrated story narration with consistency validation
- **DiscoveryModule**: Visual preference assessment and personalized world recommendations

### **Key Classes & Middleware (Enhanced)**

```python
class SystemPromptManager:
    def get_personalized_prompt(user_personality, world_context, prompt_type)
    def evaluate_effectiveness(prompt_id, user_engagement)
    def optimize_strategy(analytics_data)

class CoherenceEngine:
    def validate_consistency(world_artifacts, new_content)
    def maintain_character_memory(character_id, interactions)
    def enforce_world_rules(world_rules, user_action)

class PersonalityAnalyzer:
    def perform_rolling_assessment(interaction_logs)
    def update_personality_model(user_id, new_traits)
    def generate_confidence_score(assessment_data)

class InstantGratificationController:
    def embed_rewards(story_state, engagement_level)
    def trigger_progressive_reveals(user_progress)
    def optimize_surprise_timing(user_patterns)

```

### **Enhanced Middleware Stack**

- `SystemPromptMiddleware`: Injects personalized prompts into all AI interactions
- `CoherenceValidationMiddleware`: Ensures story consistency in real-time
- `PersonalityIntegrationMiddleware`: Applies rolling assessment to user experience
- `InstantGratificationMiddleware`: Embeds rewards and engagement optimization

## Database (Enhanced)

### **Advanced Schemas / Collections**

### **User & Personality Management**

```sql
-- Enhanced user management with rolling personality
users: { id, name, age, gender, language, authType, createdAt, lastPersonalityUpdate }
personality_assessments: { id, userId, traitScores, confidenceLevel, assessmentMethod, timestamp, interactionTriggers[] }
preference_discoveries: { id, userId, adventureStyle, characterType, interests[], visualResponses[], timestamp }
personality_evolution: { id, userId, traitHistory[], confidenceEvolution[], majorChanges[], analysisLogs[] }

```

### **World & Content Management**

```sql
-- Enhanced world management with coherence tracking
worlds: { id, creatorId, title, description, genre, thumbnailUrl, previewContent, coherenceVersion, templateCompliance, artifacts, createdAt }
world_artifacts: { id, worldId, characters[], settings[], rules[], events[], storyTemplate, consistencyHash, versionHistory[] }
story_templates: { id, name, requiredElements[], optionalElements[], validationRules[], promptStrategies[] }
demo_worlds: { id, worldId, targetPersonality[], accessLevel, previewDuration, quickPlayOptimized }

```

### **System Prompt & AI Management**

```sql
-- System prompt management and optimization
system_prompts: { id, type, template, variables[], targetPersonality[], effectivenessScore, optimizationHistory[] }
prompt_effectiveness: { id, promptId, userId, sessionId, engagementScore, userSatisfaction, timestamp }
coherence_logs: { id, sessionId, worldArtifacts, consistencyScore, validationResults[], timestamp }

```

### **Engagement & Analytics**

```sql
-- Enhanced engagement tracking
sessions: { id, userId, worldId, personalitySnapshot, coherenceLevel, gratificationEvents[], startTime, endTime }
engagement_events: { id, sessionId, eventType, rewardType, userReaction, effectivenessScore, timestamp }
instant_gratification_metrics: { id, sessionId, rewardTiming[], surpriseEffectiveness[], progressiveRevealSuccess[], userSatisfaction }

```

### **Indices & Optimization (Enhanced)**

- **Personality Queries**: Index on `personality_assessments.userId` and `timestamp` for rolling updates
- **World Discovery**: Composite index on `worlds.public`, `targetPersonality`, and `createdAt` for personalized recommendations
- **System Prompt Optimization**: Index on `prompt_effectiveness.promptId` and `engagementScore` for real-time optimization
- **Quick Play**: Dedicated indices for `demo_worlds.accessLevel` and `quickPlayOptimized` for instant access

## Enhanced Decisions & Resolutions

### **AI & System Prompt Strategy**

1. **System Prompt Architecture**: Centralized prompt management with real-time personalization
2. **Coherence Strategy**: World artifacts maintain consistency; system prompts enforce rules
3. **Rolling Assessment**: LLM-powered personality analysis triggered by interaction patterns
4. **Instant Gratification**: System prompt-embedded rewards with engagement optimization

### **User Experience & Engagement**

1. **Demo Mode**: Immediate magical world access for instant user engagement
2. **Preference Discovery**: Visual card-based assessment (3-5 questions max) replacing traditional surveys
3. **Quick Play**: <10 second world initialization with personality-aware setup
4. **Progressive Revelation**: Story elements unlock based on engagement patterns

### **Technical Implementation**

1. **GenAI Co-Creation**: System prompt-guided collaborative world building with creativity stimulation
2. **Real-time Coherence**: Artifact-aware story generation with consistency validation
3. **Personality Integration**: Rolling assessment applied to all user interactions
4. **Performance Optimization**: System prompt caching and quick play infrastructure

### **Content & Safety**

1. **Age-Appropriate Prompts**: Specialized system prompts ensure child-safe content generation
2. **World Rule Enforcement**: GenAI constrained by world artifacts while allowing creative branching
3. **Template Compliance**: Story frameworks ensure minimum viable world requirements
4. **Content Validation**: Real-time safety checking through prompt-based filtering

### **Analytics & Optimization**

1. **Prompt Effectiveness Tracking**: Continuous optimization of system prompt strategies
2. **Engagement Metrics**: Instant gratification effectiveness and user satisfaction monitoring
3. **Personality Accuracy**: Confidence scoring and assessment validation
4. **Coherence Quality**: Story consistency and world rule adherence measurement

### **Future Scalability**

1. **Algorithm-Based Matching**: Framework for advanced world recommendation beyond timestamp sorting
2. **Multi-modal Integration**: Audio narration and visual animation support architecture
3. **Advanced Analytics**: Machine learning-powered engagement optimization and personality modeling
4. **Content Ecosystem**: Community-driven world creation with quality validation systems